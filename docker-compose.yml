version: '3.8'

services:
  tg-bot-host:
    # 使用预构建镜像（推荐）
    image: ghcr.io/jyucoeng/tg_bot_platform:latest
    # 如果需要本地构建，注释上面的 image 并取消注释下面的 build
    # build: .
    
    container_name: tg_multi_bot
    restart: unless-stopped

    # 环境变量配置（直接在这里修改）
    environment:
      # ========== 必需配置 ==========
      # 为管理机器人的api token
      MANAGER_TOKEN: "YOUR_BOT_TOKEN_HERE"
      #ADMIN_CHANNEL 为频道id时为负数，为管理者的tg id为正数
      ADMIN_CHANNEL: "-1001234567890"
      
      # ========== 验证服务器配置 ==========
      #此处建议配置80系端口，如2052、2082、2086、2095、8080、8880（具体跟你cf里面配置回源的端口号一致）
      VERIFY_SERVER_URL: "https://dora.xxxx.com"
      
      # ========== CF 验证配置 ==========
      # Cloudflare Turnstile 配置（如需启用 CF 验证，取消注释并填写）
      CF_TURNSTILE_SITE_KEY: "0x4Axxxxxxxxxxxxxxxxx"
      CF_TURNSTILE_SECRET_KEY: "0x4XXXXXXXXXXxxxxxxxxxxxxxxxx"
      
      # ========== GitHub 自动备份配置 ==========
      # GitHub 自动备份配置（如需备份到 GitHub，取消注释并填写）
      GH_USERNAME: "你的github用户名"
      GH_REPO: "你的github仓库名字"
      GH_TOKEN: "ghp_token很长的一串"

    # 数据卷挂载（持久化数据库）
    volumes:
      - ./data:/app/data

    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # 健康检查
    healthcheck:
      test: ["CMD", "python", "-c", "import os; exit(0 if os.path.exists('/app/data/bot_data.db') else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  tg-verify-server:
    # 使用预构建镜像（推荐）
    image: ghcr.io/jyucoeng/tg_bot_platform:latest
    # 如果需要本地构建，注释上面的 image 并取消注释下面的 build
    # build: .
    
    container_name: tg_verify_server
    restart: unless-stopped
    
    # 端口映射（CF验证服务器需要外部访问，修改全面的端口为80系端口，也就是你cf里面配置的回源端口，如2052、2082、2086、2095、8080、8880）
    ports:
      - "2082:5000"
    
    # 环境变量配置（与host服务保持一致）
    environment:
      # ========== 必需配置 ==========
      # ========== bot的api token 和宿主tg id ==========
      # 为管理机器人的api token
      MANAGER_TOKEN: "YOUR_BOT_TOKEN_HERE"
      #ADMIN_CHANNEL 为频道id时为负数，为管理者的tg id为正数
      ADMIN_CHANNEL: "1001234567890"
      
      # ========== 验证服务器配置 ==========
      VERIFY_SERVER_URL: "https://dora.xxxx.com"
      VERIFY_SERVER_PORT: 2082
      
      # ========== CF 验证配置 ==========
      # Cloudflare Turnstile 配置（如需启用 CF 验证，取消注释并填写）
      CF_TURNSTILE_SITE_KEY: "0x4Axxxxxxxxxxxxxxxxx"
      CF_TURNSTILE_SECRET_KEY: "0x4XXXXXXXXXXxxxxxxxxxxxxxxxx"
      
      # ========== GitHub 自动备份配置 ==========
      # GitHub 自动备份配置（如需备份到 GitHub，取消注释并填写）
      GH_USERNAME: "你的github用户名"
      GH_REPO: "你的github仓库名字"
      GH_TOKEN: "ghp_token很长的一串"

    # 数据卷挂载（共享数据库）
    volumes:
      - ./data:/app/data

    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # 健康检查
    healthcheck:
      test: ["CMD", "python", "-c", "import os; exit(0 if os.path.exists('/app/data/bot_data.db') else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # 指定运行验证服务
    command: ["verify"]
