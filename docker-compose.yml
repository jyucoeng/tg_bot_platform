version: '3.8'

services:
  tg-bot-host:
    # 使用预构建镜像（推荐）
    image: ghcr.io/jyucoeng/tg_bot_platform:latest
    # 如果需要本地构建，注释上面的 image 并取消注释下面的 build
    # build: .
    
    container_name: tg_multi_bot
    restart: unless-stopped

    # 环境变量配置（直接在这里修改）
    environment:
      # ========== 必需配置 ==========
      MANAGER_TOKEN: "8539478673:AAFLdWNA0OnpU94u1vUjOvrYF2YXog1PSQI"
      ADMIN_CHANNEL: "6714871053"
      
      # ========== 验证服务器配置 ==========
      VERIFY_SERVER_URL: "https://littledoraemon.z2002.hidns.co:2082"
      
      # ========== CF 验证配置 ==========
      CF_TURNSTILE_SITE_KEY: "0x4AAAAAACGPjtDuU4lAW982"
      CF_TURNSTILE_SECRET_KEY: "0x4AAAAAACGPjupEGNzQIhuxeeGqQx9Yy58"
      
      # ========== GitHub 自动备份配置 ==========
      GH_USERNAME: "jyucoeng"
      GH_REPO: "TG_Talk_backup_test"
      GH_TOKEN: "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"

    # 数据卷挂载（持久化数据库）
    volumes:
      - ./data:/app/data

    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # 健康检查
    healthcheck:
      test: ["CMD", "python", "-c", "import os; exit(0 if os.path.exists('/app/data/bot_data.db') else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  tg-verify-server:
    # 使用预构建镜像（推荐）
    image: ghcr.io/jyucoeng/tg_bot_platform:latest
    # 如果需要本地构建，注释上面的 image 并取消注释下面的 build
    # build: .
    
    container_name: tg_verify_server
    restart: unless-stopped
    
    # 端口映射（CF验证服务器需要外部访问）
    ports:
      - "2082:5000"
    
    # 环境变量配置（与host服务保持一致）
    environment:
      # ========== 必需配置 ==========
      MANAGER_TOKEN: "8539478673:AAFLdWNA0OnpU94u1vUjOvrYF2YXog1PSQI"
      ADMIN_CHANNEL: "6714871053"
      
      # ========== 验证服务器配置 ==========
      VERIFY_SERVER_URL: "https://littledoraemon.z2002.hidns.co"
      VERIFY_SERVER_PORT: 2082
      
      # ========== CF 验证配置 ==========
      CF_TURNSTILE_SITE_KEY: "0x4AAAAAACGPjtDuU4lAW982"
      CF_TURNSTILE_SECRET_KEY: "0x4AAAAAACGPjupEGNzQIhuxeeGqQx9Yy58"
      
      # ========== GitHub 自动备份配置 ==========
      GH_USERNAME: "jyucoeng"
      GH_REPO: "TG_Talk_backup_test"
      GH_TOKEN: "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"

    # 数据卷挂载（共享数据库）
    volumes:
      - ./data:/app/data

    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # 健康检查
    healthcheck:
      test: ["CMD", "python", "-c", "import os; exit(0 if os.path.exists('/app/data/bot_data.db') else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # 指定运行验证服务
    command: ["verify"]
