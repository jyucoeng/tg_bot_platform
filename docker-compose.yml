version: '3.8'

# Common configurations used across multiple services
x-common-service-config: &common-service-config
  restart: unless-stopped
  volumes:
    - ./data:/app/data
  logging:
    driver: "json-file"
    options:
      max-size: "10m"
      max-file: "3"
  healthcheck:
    test: ["CMD", "python", "-c", "import os; exit(0 if os.path.exists('/app/data/bot_data.db') else 1)"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 40s

# Shared environment variables (common across both tg-bot-host and tg-verify-server)
x-common-environment: &common-environment
  - MANAGER_TOKEN=${MANAGER_TOKEN}  # 为管理机器人的api token
  - ADMIN_CHANNEL=${ADMIN_CHANNEL}  #ADMIN_CHANNEL 为频道id时为负数，如-1001234567890，为管理者的tg id为正数
  - GH_USERNAME=${GH_USERNAME}     #你的github用户名 
  - GH_REPO=${GH_REPO}             #你的github仓库名字
  - GH_TOKEN=${GH_TOKEN}           #ghp_token很长的一串

# Specific environment variables for tg-verify-server
x-verify-server-environment: &verify-server-environment
  - CF_TURNSTILE_SITE_KEY=${CF_TURNSTILE_SITE_KEY}          ## Cloudflare Turnstile 配置（如需启用 CF 验证，请填写填写）
  - CF_TURNSTILE_SECRET_KEY=${CF_TURNSTILE_SECRET_KEY}      ## Cloudflare Turnstile 配置（如需启用 CF 验证，请填写填写）
  - VERIFY_SERVER_URL=${VERIFY_SERVER_URL}    #验证服务器配置,必须是域名,如https://dora.xxxx.com，可以不写端口号
  - VERIFY_SERVER_PORT=${VERIFY_SERVER_PORT}  # This is the environment variable for the port ,如 2082

# Shared build flag for local build
x-build-locally: &build-locally
  BUILD_LOCALLY: "true"  # Control local build, set to true to build locally  假如你想本地构建，请设置为true，直接用线上的镜像就用false，一般不用用户自己配，是开发者配的

services:
  tg-bot-host:
    <<: *common-service-config  # Merge common configuration
    build:
      context: ./  # Build context for local builds
      dockerfile: Dockerfile  # Specify the Dockerfile (if needed)
      args:
        <<: *build-locally  # Use the build-locally variable for local build control
    image: ghcr.io/jyucoeng/tg_bot_platform:latest  # Default to registry image
    container_name: tg_multi_bot
    environment:
      <<: *common-environment  # Use shared environment variables (for tg-bot-host)
    # No need to expose ports for tg-bot-host since it's just a bot host service (no direct interaction)

  tg-verify-server:
    <<: *common-service-config  # Merge common configuration
    build:
      context: ./  # Build context for local builds
      dockerfile: Dockerfile  # Specify the Dockerfile (if needed)
      args:
        <<: *build-locally  # Use the build-locally variable for local build control
    image: ghcr.io/jyucoeng/tg_bot_platform:latest  # Default to registry image
    container_name: tg_verify_server
    environment:
      <<: *common-environment  # Use shared environment variables
      <<: *verify-server-environment  # Use specific environment variables for tg-verify-server
    ports:
      - "${VERIFY_SERVER_PORT}:5000"  # Use VERIFY_SERVER_PORT for host port and container port is fixed at 5000

volumes:
  postgres_data:
