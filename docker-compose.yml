version: '3.8'

services:
  tg-bot-host:
    # 使用预构建镜像（推荐）
    image: ghcr.io/jyucoeng/tg_bot_platform:latest
    # 如果需要本地构建，注释上面的 image 并取消注释下面的 build
    # build: .
    
    container_name: tg_multi_bot
    restart: unless-stopped

    # 环境变量配置（直接在这里修改）
    environment:
      # ========== 必需配置 ==========
      # 1. 管理机器人 Token（从 @BotFather 获取）
      MANAGER_TOKEN: "YOUR_BOT_TOKEN_HERE"
      
      # 2. 管理员频道/群组 ID（接收通知的频道/群组）
      ADMIN_CHANNEL: "-1001234567890"
      
      # ========== 可选配置 ==========
      # GitHub 自动备份配置（如需备份到 GitHub，取消注释并填写）
      # GH_USERNAME: "your_github_username"
      # GH_REPO: "tg-bot-backup"
      # GH_TOKEN: "ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"

    # 数据卷挂载（持久化数据库）
    volumes:
      - ./data:/app/data

    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # 健康检查
    healthcheck:
      test: ["CMD", "python", "-c", "import os; exit(0 if os.path.exists('/app/data/bot_data.db') else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  tg-verify-server:
    # 使用预构建镜像（推荐）
    image: ghcr.io/jyucoeng/tg_bot_platform:latest
    # 如果需要本地构建，注释上面的 image 并取消注释下面的 build
    # build: .
    
    container_name: tg_verify_server
    restart: unless-stopped
    
    # 端口映射（CF验证服务器需要外部访问）
    ports:
      - "80:5000"
    
    # 环境变量配置
    environment:
      # ========== 必需配置 ==========
      # 管理机器人 Token（与host服务保持一致）
      MANAGER_TOKEN: "YOUR_BOT_TOKEN_HERE"
      
      # ========== CF 验证配置 ==========
      # Cloudflare Turnstile 配置（如需启用 CF 验证，取消注释并填写）
      # CF_TURNSTILE_SITE_KEY: "your_site_key"
      # CF_TURNSTILE_SECRET_KEY: "your_secret_key"
      # VERIFY_SERVER_URL: "http://localhost"
      # VERIFY_SERVER_PORT: 5000

    # 数据卷挂载（共享数据库）
    volumes:
      - ./data:/app/data

    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # 健康检查
    healthcheck:
      test: ["CMD", "python", "-c", "import os; exit(0 if os.path.exists('/app/data/bot_data.db') else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # 指定运行验证服务
    command: ["verify"]